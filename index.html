---
layout: default
---

<h1 id="label-knife-solo">knife-solo<span><a href="#label-knife-solo">&para;</a> <a href="#top">&uarr;</a></span></h1>

<h2 id="label-DESCRIPTION-3A">DESCRIPTION:<span><a href="#label-DESCRIPTION-3A">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>knife-solo adds a handful of commands that aim to make working with
chef-solo as powerful as chef-server. It currently adds 5 subcommands to
knife:</p>
<ul><li>
<p><code>knife solo init</code> is used to create a new directory structure
(i.e. “kitchen”) that fits with Chef&#39;s standard structure and can be
used to build and store recipes.</p>
</li><li>
<p><code>knife solo prepare</code> installs Chef on a given host. It&#39;s
structured to auto-detect the target OS and change the installation process
accordingly.</p>
</li><li>
<p><code>knife solo cook</code> uploads the current kitchen (Chef repo) to the
target host and runs chef-solo on that host.</p>
</li><li>
<p><code>knife solo bootstrap</code> combines the two previous ones (prepare
and cook). knife-solo also adds <code>--solo</code> command line option and
+<a href=":solo">knife</a>+ configuration parameter to <code>knife
bootstrap</code> that can be used for triggering “knife solo bootstrap”
instead of the normal template based chef-client bootstrap.</p>
</li><li>
<p><code>knife solo clean</code> removes the uploaded kitchen from the target
host.</p>
</li></ul>

<p>Preliminary Windows support for “knife solo cook” is available (see below).</p>

<h2 id="label-USAGE-3A">USAGE:<span><a href="#label-USAGE-3A">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Installation is a normal gem installation.</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-identifier">install</span> <span class="ruby-identifier">knife</span><span class="ruby-operator">-</span><span class="ruby-identifier">solo</span>

<span class="ruby-comment"># or if using ChefDK</span>
<span class="ruby-identifier">chef</span> <span class="ruby-identifier">gem</span> <span class="ruby-identifier">install</span> <span class="ruby-identifier">knife</span><span class="ruby-operator">-</span><span class="ruby-identifier">solo</span>
</pre>

<p>If you need to install from git run:</p>

<pre>bundle &amp;&amp; bundle exec rake install</pre>

<h2 id="label-Integration+with+Berkshelf+-26+Librarian">Integration with Berkshelf &amp; Librarian<span><a href="#label-Integration+with+Berkshelf+-26+Librarian">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>knife-solo also integrates with <a
href="http://berkshelf.com/">Berkshelf</a> and <a
href="https://github.com/applicationsonline/librarian-chef">Librarian-Chef</a>
for managing your cookbooks out of the box.</p>

<p>We try to do this somewhat automatically by first checking if you have
either of the two gems installed. If you have both, we will default to
Berkshelf.</p>

<p>During <code>knife solo init</code> we&#39;ll generate the appropriate
configuration file for either gem. Then during <code>knife solo cook</code>
we&#39;ll run the installation step for whichever configuration file is in
your kitchen.</p>

<p>Both commands accept option flags to disable this feature if needed
(<code>--no-berkshelf</code> or <code>--no-librarian</code>). The init
command also offers enable flags to generate configuration files regardless
of whether or not you have the supporting gem installed.</p>

<p>More detailed logic for this integration is available in the <a
href="https://github.com/matschaffer/knife-solo/wiki/Berkshelf-&-Librarian-Chef-integration">Berkshelf
& Librarian-Chef integration</a> wiki page.</p>

<h3 id="label-A+note+about+the+-22cookbooks-22+directory">A note about the “cookbooks” directory<span><a href="#label-A+note+about+the+-22cookbooks-22+directory">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>One common “gotcha” is that you may have Berkshelf or Librarian-Chef
installed without knowing it. This will generate a kitchen that is
configured to use them which might not have been your intention. Once the
configuration file is available, the <code>cookbooks</code> directory will
be reserved for cookbooks that are resolved via one of those tools. Any
cookbooks that you create there will be removed when you run <code>knife
solo cook</code>.</p>

<p>Please use <code>site-cookbooks</code> for custom cookbooks or (better yet)
give them their own git repositories which are then included using
Berkshelf or Librarian-Chef.</p>

<h2 id="label-knife-solo+commands">knife-solo commands<span><a href="#label-knife-solo+commands">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Init+command">Init command<span><a href="#label-Init+command">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The init command simply takes a name of the directory to store the kitchen
structure. Use “.” to initialize the current directory.</p>

<pre class="ruby"><span class="ruby-identifier">knife</span> <span class="ruby-identifier">solo</span> <span class="ruby-identifier">init</span> <span class="ruby-identifier">mychefrepo</span>
</pre>

<p>Currently the directory structure looks like this, but could change as
development continues.</p>

<pre class="ruby"><span class="ruby-identifier">mychefrepo</span><span class="ruby-operator">/</span>
<span class="ruby-identifier">├──</span> .<span class="ruby-identifier">chef</span>
<span class="ruby-identifier">│</span>   <span class="ruby-identifier">└──</span> <span class="ruby-identifier">knife</span>.<span class="ruby-identifier">rb</span>
<span class="ruby-identifier">├──</span> <span class="ruby-identifier">cookbooks</span>
<span class="ruby-identifier">├──</span> <span class="ruby-identifier">data_bags</span>
<span class="ruby-identifier">├──</span> <span class="ruby-identifier">nodes</span>
<span class="ruby-identifier">├──</span> <span class="ruby-identifier">roles</span>
<span class="ruby-identifier">└──</span> <span class="ruby-identifier">site</span><span class="ruby-operator">-</span><span class="ruby-identifier">cookbooks</span>
</pre>

<h3 id="label-Prepare+command">Prepare command<span><a href="#label-Prepare+command">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The prepare command takes an ssh-style host argument as follows:</p>

<pre>knife solo prepare ubuntu@10.0.0.201</pre>

<p>It will look up SSH information from <code>~/.ssh/config</code> or in the
file specified by <code>-F</code>. You can also pass port information
(<code>-p</code>), identity information (<code>-i</code>), or a password
(<code>-P</code>). It will use sudo to run some of these commands and will
prompt you for the password if it&#39;s not supplied on the command line.</p>

<p>This command will make a best-effort to detect and install Chef Solo on
your target operating system. We use the <a
href="http://www.opscode.com/chef/install/">Opscode Installer</a> wherever
possible.</p>

<p>If you need specific behavior you can fallback to a knife bootstrap command
with an empty runlist using the following:</p>

<pre>knife bootstrap --template-file bootstrap.centos.erb -u root 172.16.144.132
echo &#39;{&quot;run_list&quot;:[]}&#39; &gt; nodes/172.16.144.132.json</pre>

<p>Bootstrap templates are quite simple, as shown in <a
href="https://gist.github.com/2402433">this gist for
bootstrap.centos.erb</a>.</p>

<p>Or if your modifications provide some general benefit, consider sending a
pull request to <a href="https://github.com/matschaffer/knife-solo">this
project</a> or <a href="https://github.com/opscode/omnibus">the omnibus
installer</a>.</p>

<h3 id="label-Cook+command">Cook command<span><a href="#label-Cook+command">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The cook command also takes an ssh-style host argument:</p>

<pre>knife solo cook ubuntu@10.0.0.201</pre>

<p>The cook command uploads the current kitchen to the server and runs
chef-solo on that server. If you only specify one argument it will look for
a node config in <code>nodes/&lt;hostname&gt;.json</code>. Or if you want
to specify a node config you can pass the path to the file as the second
argument.</p>

<p>This uploads all of your cookbooks in addition to a patch that allows you
to use data_bags in a read-only fashion from the <code>data_bags</code>
folder.</p>

<p>This also supports encrypted data bags. To use them, set the path to your
key with <code>encrypted_data_bag_secret</code> in .chef/knife.rb.</p>

<p>The built-in knife commands for working with data bags don&#39;t work well
without a Chef server so we recommend using the <a
href="https://github.com/thbishop/knife-solo_data_bag">knife-solo_data_bag</a>
gem. This will provide “solo” versions of all the typical data bag
commands. The default kitchen structure generated by <code>knife solo
init</code> should be compatible with all the operations listed in the
documentation for that gem.</p>

<p>If you want to run chef-solo in legacy mode, you may use
<code>--legacy-mode</code> option or put +solo_legacy_mode true+ into
.chef/knife.rb.</p>

<h3 id="label-Bootstrap+command">Bootstrap command<span><a href="#label-Bootstrap+command">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The bootstrap command takes the same arguments and most of the options as
prepare and cook:</p>

<pre>knife solo bootstrap ubuntu@10.0.0.201</pre>

<p>Under the hood it first calls +knife solo prepare+ and then +knife solo
cook+ with the specified arguments and options.</p>

<h4 id="label-Integration+with+knife+bootstrap">Integration with knife bootstrap<span><a href="#label-Integration+with+knife+bootstrap">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>knife-solo also integrates with <code>knife bootstrap</code> by adding
<code>--solo</code> command line option and +<a href=":solo">knife</a>+
configuration parameter to it. When requested, “knife solo bootstrap” is
used instead of the normal template based chef-client bootstrap. This is
especially useful with other knife plugins like <a
href="https://github.com/opscode/knife-ec2">knife-ec2</a> that invoke
“knife bootstrap” after creating an server instance. Even if these plugins
do not have the “–solo” option, you can put <code>knife[:solo] =
true</code> in knife.rb.</p>

<h3 id="label-Clean+command">Clean command<span><a href="#label-Clean+command">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The clean command takes the same arguments like prepare and cook:</p>

<pre>knife solo clean ubuntu@10.0.0.201</pre>

<p>The clean command removes an uploaded kitchen completely from the target
host. This improves security because passwords etc. are not left behind on
that host.</p>

<h3 id="label-Windows+support">Windows support<span><a href="#label-Windows+support">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The cook command will work on Windows node if you meet the following howto:</p>

<h4 id="label-Init+as+normally">Init as normally<span><a href="#label-Init+as+normally">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p>run <code>knife solo init</code></p>
</li></ul>

<h4 id="label-Prepare+the+node+manually">Prepare the node manually<span><a href="#label-Prepare+the+node+manually">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p>install a SSH server (eg: WinSSHd)</p>
</li><li>
<p>install rsync on the node (see <a
href="https://github.com/thbar/rsync-windows">github.com/thbar/rsync-windows</a>)</p>
</li><li>
<p>add rsync to the user PATH</p>
</li><li>
<p>install <a
href="http://www.opscode.com/chef/install.msi">www.opscode.com/chef/install.msi</a></p>
</li><li>
<p>add nodes/hostname.json and put <code>{ &quot;run_list&quot;: [] }</code>
in it</p>
</li></ul>

<h4 id="label-Cook">Cook<span><a href="#label-Cook">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p>cook should work as expected automatically, if you use cygwin rsync. If
you&#39;re using MinGW / Git Bash, or you have a non-standard
<code>cygdrive</code> setting, you can set that in
<code>.chef/knife.rb</code>:</p>

<pre class="ruby"><span class="ruby-identifier">knife</span>[<span class="ruby-value">:cygdrive_prefix_local</span>] = <span class="ruby-string">&#39;/cygdrive&#39;</span>  <span class="ruby-comment"># prefix for your local machine, set to empty string for MinGW</span>
<span class="ruby-identifier">knife</span>[<span class="ruby-value">:cygdrive_prefix_remote</span>] = <span class="ruby-string">&#39;/cygdrive&#39;</span> <span class="ruby-comment"># prefix on the remote windows node</span>
</pre>
</li></ul>

<h2 id="label-DEVELOPMENT">DEVELOPMENT<span><a href="#label-DEVELOPMENT">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Get set up by running <code>./script/newb</code> this will do some of the
steps and guide you through the rest. If it doesn&#39;t run for you, feel
free to <a href="https://github.com/matschaffer/knife-solo/issues">file an
issue</a>.</p>

<p>When running integration tests all output is sent to the log directory into
a file that matches matches the test case name. The EC2Runner log is the
main runner log that contains information about instance provisioning.</p>

<p>Note that instances will remain running until your tests pass. This aids in
speeding up the test cycle. Upon succesfful test completion you&#39;ll be
given 10 seconds to cancel the process before the instances are cleaned up.
Note that any instance tagged with <code>knife_solo_integration_user ==
$USER</code> will be cleaned up. Or if you want to leave your instances
running regardless, specify <code>SKIP_DESTROY=true</code> as an
environment variable.</p>

<p>To make an integration test, create a file in the
<code>test/integration</code> directory and a test class that inherits from
<code>IntegrationTest</code> and includes a module from
<code>test/integration/cases</code>. You can override methods as necessary,
but generally you only need to override <code>user</code> and
<code>image_id</code> to specify the user name and AMI ID.</p>

<p>If you&#39;re interested in contributing, contact me via GitHub or have a
look at the <a
href="https://github.com/matschaffer/knife-solo/issues">GitHub issues
page</a>.</p>
